<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReLife - Your Wellness Journey</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf.js for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Custom font import for Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 1rem; /* Padding around the content */
            box-sizing: border-box;
        }

        /* Styling for the message box */
        .message-box {
            padding: 0.75rem 1.25rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            text-align: center;
            opacity: 0; /* Initially hidden */
            transition: opacity 0.3s ease-in-out;
        }

        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            opacity: 1;
        }

        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            opacity: 1;
        }

        /* Custom radio button styling for wellness solutions */
        .radio-card input[type="radio"] {
            display: none; /* Hide default radio button */
        }

        .radio-card label {
            display: block;
            background-color: #f9fafb; /* Light background for unselected */
            border: 2px solid #e5e7eb; /* Light border */
            border-radius: 0.75rem; /* Rounded corners */
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            font-weight: 500;
            color: #4b5563; /* Darker text */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }

        .radio-card input[type="radio"]:checked + label {
            background-color: #dbeafe; /* Light blue for selected */
            border-color: #3b82f6; /* Blue border for selected */
            color: #1e40af; /* Darker blue text for selected */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* More prominent shadow */
            transform: translateY(-2px); /* Slight lift effect */
        }

        .radio-card label:hover {
            border-color: #93c5fd; /* Lighter blue on hover */
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.08), 0 1px 2px -1px rgba(0, 0, 0, 0.04);
        }

        /* Basic spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        /* Print-specific styles */
        @media print {
            body {
                background-color: #ffffff;
                padding: 0;
            }
            #appContainer {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }
            .no-print {
                display: none !important;
            }
            .app-screen {
                display: none !important;
            }
            /* Ensure the correct report is shown when printing */
            .printable-report {
                display: block !important;
            }
            #appSubtitle, h1 {
                display: none;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <div id="appContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ReLife</h1>
        <p class="text-center text-gray-600 mb-8" id="appSubtitle">Your Wellness Journey</p>

        <!-- Message box for displaying success or error messages -->
        <div id="messageBox" class="message-box"></div>

        <!-- Screen 1: Customer Verification -->
        <div id="verificationScreen" class="app-screen">
            <div class="mb-8 p-4 bg-green-100 border-l-4 border-green-500 text-green-800 text-center">
                <p><strong>Diabetes is Reversible!</strong></p>
            </div>
            <div class="mb-6">
                <label for="mobileNumber" class="block text-gray-700 text-sm font-medium mb-2">Mobile Number</label>
                <input type="tel" id="mobileNumber" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., +1234567890" pattern="[0-9+\s()-]*" required>
            </div>
            <button id="sendOtpButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md">
                Send OTP
            </button>
            <div id="otpSection" class="mt-8 hidden">
                <label for="otp" class="block text-gray-700 text-sm font-medium mb-2">Enter OTP</label>
                <input type="text" id="otp" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., 123456" pattern="[0-9]{6}" maxlength="6" required>
                <button id="verifyOtpButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md mt-4">
                    Verify OTP
                </button>
            </div>
        </div>

        <!-- Screen 2: KYC -->
        <div id="kycScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToVerification" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Tell us about yourself</p>
            </div>
            <form id="kycForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="fullName" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="fullName" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="John Doe" required>
                    </div>
                    <div>
                        <label for="age" class="block text-gray-700 text-sm font-medium mb-2">Age</label>
                        <input type="number" id="age" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., 30" min="1" max="120" required>
                    </div>
                    <div>
                        <label for="heightCm" class="block text-gray-700 text-sm font-medium mb-2">Height (cm)</label>
                        <input type="number" id="heightCm" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., 175" min="50" max="250" required>
                    </div>
                    <div>
                        <label for="weightKg" class="block text-gray-700 text-sm font-medium mb-2">Weight (kg)</label>
                        <input type="number" id="weightKg" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., 70" min="20" max="300" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="gender" class="block text-gray-700 text-sm font-medium mb-2">Gender</label>
                    <select id="gender" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="dietType" class="block text-gray-700 text-sm font-medium mb-2">Diet Type</label>
                    <select id="dietType" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" required>
                        <option value="">Select Diet Type</option>
                        <option value="vegetarian">Vegetarian</option>
                        <option value="non-vegetarian">Non-Vegetarian</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="lifestyle" class="block text-gray-700 text-sm font-medium mb-2">Lifestyle</label>
                    <select id="lifestyle" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" required>
                        <option value="">Select Lifestyle</option>
                        <option value="sedentary">Sedentary (little to no exercise)</option>
                        <option value="lightly-active">Lightly Active (light exercise/sports 1-3 days/week)</option>
                        <option value="moderately-active">Moderately Active (moderate exercise/sports 3-5 days/week)</option>
                        <option value="very-active">Very Active (hard exercise/sports 6-7 days a week)</option>
                        <option value="extra-active">Extra Active (very hard exercise/physical job)</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="dietaryPreferences" class="block text-gray-700 text-sm font-medium mb-2">Dietary Preferences (e.g., No dairy, Allergic to nuts, Vegan)</label>
                    <textarea id="dietaryPreferences" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out h-24 resize-y" placeholder="e.g., No dairy, Allergic to nuts"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                    Submit Details
                </button>
            </form>
        </div>

        <!-- Screen 3: Wellness Solution Selection -->
        <div id="solutionScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToKyc" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Choose Your Wellness Solution</p>
            </div>
            <form id="solutionForm">
                <div class="space-y-4 mb-8">
                    <div class="radio-card">
                        <input type="radio" id="diabetesRemission" name="wellnessSolution" value="Diabetes Remission" required>
                        <label for="diabetesRemission">Diabetes Remission (manage blood glucose without medicine)</label>
                    </div>
                    <div class="radio-card">
                        <input type="radio" id="bloodPressure" name="wellnessSolution" value="Blood Pressure Management">
                        <label for="bloodPressure">Blood Pressure Management</label>
                    </div>
                    <div class="radio-card">
                        <input type="radio" id="diabetesReversal" name="wellnessSolution" value="Diabetes Reversal">
                        <label for="diabetesReversal">Diabetes Reversal</label>
                    </div>
                    <div class="radio-card">
                        <input type="radio" id="weightLoss" name="wellnessSolution" value="Weight Loss">
                        <label for="weightLoss">Weight Loss</label>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                    Proceed to Subscription
                </button>
            </form>
            <div id="subscriptionSection" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <h2 class="text-xl font-semibold text-blue-800 mb-4 text-center">Your Selected Plan</h2>
                <p class="text-lg text-gray-700 mb-2">Solution: <span id="selectedSolution" class="font-bold text-blue-700"></span></p>
                <p class="text-lg text-gray-700 mb-4">Subscription Fee: <span id="subscriptionFee" class="font-bold text-green-600 text-2xl"></span></p>
                <button id="confirmSubscriptionButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                    Confirm Subscription
                </button>
            </div>
        </div>

        <!-- Screen 4: Calorie Consumption Report -->
        <div id="calorieReportScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToSolution" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Your Personalized Calorie Report</p>
            </div>
            <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">Your Profile Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <p><strong>Name:</strong> <span id="userName"></span></p>
                    <p><strong>Age:</strong> <span id="userAge"></span> years</p>
                    <p><strong>Height:</strong> <span id="userHeight"></span> cm</p>
                    <p><strong>Weight:</strong> <span id="userWeight"></span> kg</p>
                    <p><strong>Gender:</strong> <span id="userGender"></span></p>
                    <p><strong>Lifestyle:</strong> <span id="userLifestyle"></span></p>
                    <p><strong>Diet Type:</strong> <span id="userDietType"></span></p>
                    <p><strong>BMI:</strong> <span id="userBmi" class="font-bold"></span></p>
                    <p class="md:col-span-2"><strong>Weight Status:</strong> <span id="userWeightStatus" class="font-bold"></span></p>
                </div>
            </div>
            <div class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                <h2 class="text-xl font-semibold text-green-800 mb-4">Estimated Daily Calorie Needs</h2>
                <p class="text-lg text-gray-700 mb-2">Basal Metabolic Rate (BMR): <span id="bmrValue" class="font-bold text-green-700"></span> calories/day</p>
                <p class="text-lg text-gray-700">Total Daily Energy Expenditure (TDEE): <span id="tdeeValue" class="font-bold text-green-700 text-2xl"></span> calories/day</p>
                <p class="text-sm text-gray-500 mt-2">This is an estimate of the calories your body needs daily to maintain your current weight based on your activity level.</p>
            </div>
            <button id="generateMealPlanButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                Generate Meal Plan
            </button>
        </div>

        <!-- Screen 5: Meal Plan Report -->
        <div id="mealPlanScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToCalorieReport" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Your Personalized Meal Plan</p>
            </div>
            <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">Your Daily Calorie & Macro Goals</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-4">
                    <p><strong>Estimated Daily Calories (TDEE):</strong> <span id="mealPlanTdeeValue" class="font-bold text-blue-700"></span> calories</p>
                    <p><strong>Your Current Weight:</strong> <span id="mealPlanUserWeight" class="font-bold text-blue-700"></span> kg</p>
                    <p class="md:col-span-2"><strong>Ideal Body Weight (Est.):</strong> <span id="mealPlanIbw" class="font-bold text-blue-700"></span> kg</p>
                </div>
                <div class="mb-4 mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-lg font-semibold text-yellow-800">
                        Target for 500g/week weight loss: <span id="targetWeightLossCalories" class="font-bold text-red-600 text-2xl"></span> calories/day
                    </p>
                    <p class="text-sm text-gray-600 mt-1">
                        This target is based on a daily deficit of approximately 550 calories to achieve a 500g (approx. 1.1 lb) weight loss per week.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-700">
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Carbohydrates</p>
                        <p class="text-2xl font-bold text-purple-600"><span id="carbGrams"></span>g</p>
                        <p class="text-sm text-gray-500">(<span id="carbCalories"></span> kcal)</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Protein</p>
                        <p class="text-2xl font-bold text-red-600"><span id="proteinGrams"></span>g</p>
                        <p class="text-sm text-gray-500">(<span id="proteinCalories"></span> kcal)</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Fats</p>
                        <p class="text-2xl font-bold text-yellow-600"><span id="fatGrams"></span>g</p>
                        <p class="text-sm text-gray-500">(<span id="fatCalories"></span> kcal)</p>
                    </div>
                </div>
            </div>
            
            <!-- AI Recipe Generation Section -->
            <div class="mt-8 p-6 bg-indigo-50 border border-indigo-200 rounded-lg">
                <h2 class="text-xl font-semibold text-indigo-800 mb-4 flex items-center">
                    âœ¨ Your AI-Powered Recipe Ideas!
                </h2>
                
                <div class="mb-6">
                    <label for="availableGroceries" class="block text-gray-700 text-sm font-medium mb-2">What's in your pantry? (Optional)</label>
                    <textarea id="availableGroceries" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out h-24 resize-y" placeholder="e.g., chicken, fish, eggs, bhindi, cauliflower, rajma, rice..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">List available groceries to get tailored recipes.</p>
                </div>
                
                <button id="generateRecipesButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                    <span id="generateRecipesButtonText">Generate Recipe Ideas</span>
                    <span id="generateRecipesSpinner" class="spinner hidden"></span>
                </button>
                <div id="generatedRecipesOutput" class="mt-4 p-4 bg-white border border-gray-200 rounded-lg text-gray-800 prose prose-sm max-w-none">
                    Enter your available groceries above and click "Generate Recipe Ideas" to get personalized suggestions!
                </div>
                <p class="text-sm text-gray-500 mt-2">
                    *Recipe suggestions are AI-generated. Always verify ingredients and adjust for personal needs.*
                </p>
            </div>
            
            <!-- API Key Input Section -->
            <div id="apiKeySection" class="mt-8 p-6 bg-red-50 border border-red-200 rounded-lg hidden">
                <h2 class="text-xl font-semibold text-red-800 mb-4">API Key Required for Live App</h2>
                <p class="text-gray-700 mb-4">To generate AI-powered recipes on a live website, you need a Google Gemini API key. This feature will not work without it when running outside the original preview environment.</p>
                <ol class="list-decimal list-inside text-gray-600 mb-4 space-y-1">
                    <li>Get your free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-semibold">Google AI Studio</a>.</li>
                    <li>Paste the key below. It will be saved in your browser for future use.</li>
                </ol>
                <div>
                    <label for="geminiApiKey" class="block text-gray-700 text-sm font-medium mb-2">Your Gemini API Key</label>
                    <input type="password" id="geminiApiKey" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Enter your API key here">
                </div>
                <div class="flex items-center mt-4 space-x-4">
                    <button id="saveApiKeyButton" class="flex-grow bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg">Save Key & Generate</button>
                    <button id="clearApiKeyButton" class="text-sm text-gray-500 hover:text-red-600 hover:underline">Clear Key</button>
                </div>
            </div>

            <div class="mt-6 space-y-4 no-print">
                 <button id="viewMealPlanReportButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md hidden">
                    View Your Meal Plan Report
                </button>
                <button id="nextToHolisticPlanButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md">
                    Skip and Proceed to Holistic Plan
                </button>
            </div>
        </div>

        <!-- NEW Screen 5.5: Daily Meal Plan Report -->
        <div id="dailyMealPlanReportScreen" class="app-screen hidden printable-report">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToMealPlanFromReport" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Daily Meal Plan Report</p>
                <div class="flex">
                    <button id="downloadMealPlanButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md flex items-center justify-center">
                        Download
                    </button>
                    <button id="printMealPlanButton" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md">
                        Print
                    </button>
                </div>
            </div>

            <!-- Report Header -->
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800">ReLife Daily Meal Plan</h2>
                <p class="text-gray-600">Prepared for: <span id="mealReportFullName" class="font-semibold"></span></p>
                <p class="text-gray-500 text-sm">Date: <span id="mealReportDate"></span></p>
            </div>

            <!-- Input Summary -->
            <div class="mb-6 p-4 border-l-4 border-blue-500 bg-blue-50">
                <h3 class="text-xl font-semibold text-blue-800 mb-2">1. Plan Basis</h3>
                <p><strong>Diet Type:</strong> <span id="mealReportDietType"></span></p>
                <p><strong>Pantry Items Provided:</strong> <span id="mealReportPantryItems"></span></p>
                <p><strong>Dietary Preferences:</strong> <span id="mealReportDietaryPreferences"></span></p>
                <p><strong>Target Calories:</strong> <span id="mealReportTargetCalories" class="font-bold"></span> kcal/day</p>
            </div>

            <!-- Generated Meal Plan -->
            <div class="mb-6 p-6 bg-gray-50 border border-gray-200 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Your AI-Generated Meal Plan</h3>
                <div id="dailyMealPlanReportOutput" class="prose prose-sm max-w-none text-gray-800">
                    <!-- Content will be populated by JS -->
                </div>
            </div>

            <button id="mealReportToHolisticPlanButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                Proceed to Holistic Plan
            </button>
        </div>


        <!-- Screen 6: Holistic Wellness Plan -->
        <div id="holisticPlanScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToMealPlan" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Your Holistic Wellness Plan</p>
            </div>
            <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Sleep Plan
                </h2>
                <p class="text-gray-700 mb-4">
                    Quality sleep is crucial for overall health, recovery, and metabolic function. Aim for consistent sleep patterns.
                </p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Target:</strong> 7-9 hours of sleep per night for most adults.</li>
                    <li><strong>Consistency:</strong> Go to bed and wake up at the same time each day, even on weekends.</li>
                    <li><strong>Environment:</strong> Ensure your bedroom is dark, quiet, and cool.</li>
                    <li><strong>Routine:</strong> Establish a relaxing bedtime routine (e.g., reading, warm bath, meditation).</li>
                    <li><strong>Avoid:</strong> Limit screen time before bed, and avoid caffeine/heavy meals late in the evening.</li>
                </ul>
            </div>
            <div class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                <h2 class="text-xl font-semibold text-green-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Intermittent Fasting Plan
                </h2>
                <p class="text-gray-700 mb-4">
                    Intermittent fasting can be a powerful tool for metabolic health and weight management, when done correctly.
                </p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Method:</strong> Consider a 16/8 method (16 hours fasting, 8-hour eating window).</li>
                    <li><strong>Example:</strong> Fast from 8 PM to 12 PM the next day, with an eating window from 12 PM to 8 PM.</li>
                    <li><strong>Hydration:</strong> Drink plenty of water, black coffee, or plain tea during fasting periods.</li>
                    <li><strong>Nutrient-dense meals:</b> During your eating window, focus on whole, unprocessed foods.</li>
                    <li><strong>Listen to your body:</strong> Adjust as needed and consult a professional if unsure.</li>
                </ul>
            </div>
            <div class="mb-8 p-6 bg-purple-50 border border-purple-200 rounded-lg">
                <h2 class="text-xl font-semibold text-purple-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Total Water Intake
                </h2>
                <p class="text-gray-700 mb-4">
                    Adequate hydration is vital for every bodily function, including metabolism and energy levels.
                </p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Target:</strong> Aim for at least 8 glasses (approx. 2 liters) of water daily.</li>
                    <li><strong>Personalization:</strong> Increase intake based on activity level, climate, and individual needs.</li>
                    <li><strong>Tips:</strong> Carry a water bottle, set reminders, and infuse water with fruits for flavor.</li>
                    <li><strong>Listen to thirst:</strong> Drink when thirsty, but don't wait until you're parched.</li>
                </ul>
            </div>
            <div class="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h2 class="text-xl font-semibold text-yellow-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Exercise Plan
                </h2>
                <p class="text-gray-700 mb-4">
                    Regular physical activity is fundamental for managing weight, improving cardiovascular health, and boosting mood.
                </p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Recommendation:</strong> At least 150 minutes of moderate-intensity aerobic activity or 75 minutes of vigorous-intensity activity per week.</li>
                    <li><strong>Strength Training:</strong> Include strength training exercises for all major muscle groups at least two times a week.</li>
                    <li><strong>Flexibility:</strong> Incorporate stretching or yoga for flexibility and mobility.</li>
                    <li><strong>Variety:</strong> Mix up your workouts to keep things interesting and activate different muscle groups.</li>
                    <li><strong>Start slow:</strong> If new to exercise, begin with shorter durations and lower intensity, gradually increasing over time.</li>
                </ul>
            </div>
            <button id="nextToGlucoseInputButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                Proceed to Glucose Input
            </button>
        </div>

        <!-- Screen 7: Daily Glucose & Medication Input -->
        <div id="glucoseInputScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToHolisticPlanFromGlucose" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Daily Glucose & Medication Input</p>
            </div>
            <form id="glucoseInputForm">
                <div class="mb-6">
                    <label for="fastingGlucose" class="block text-gray-700 text-sm font-medium mb-2">Fasting Glucose (mg/dL)</label>
                    <input type="number" id="fastingGlucose" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., 90" min="40" max="400">
                </div>
                <div class="mb-6">
                    <label for="ppGlucose" class="block text-gray-700 text-sm font-medium mb-2">Post-Prandial Glucose (mg/dL)</label>
                    <input type="number" id="ppGlucose" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out" placeholder="e.g., 140" min="40" max="400">
                </div>
                <div class="mb-6">
                    <label for="medicinesTaken" class="block text-gray-700 text-sm font-medium mb-2">Medicines Taken (if any)</label>
                    <textarea id="medicinesTaken" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out h-24 resize-y" placeholder="e.g., Metformin 500mg, Insulin"></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Upload Blood Report (Optional)</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="bloodReportUpload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>Upload a file</span>
                                    <input id="bloodReportUpload" name="bloodReportUpload" type="file" class="sr-only" accept="image/*,application/pdf,.doc,.docx">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PDF, PNG, JPG, DOC up to 10MB</p>
                        </div>
                    </div>
                    <p id="fileNameDisplay" class="text-sm text-gray-500 mt-2"></p>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                    Save & Proceed
                </button>
            </form>
        </div>

        <!-- Screen 8: Home Remedies -->
        <div id="homeRemediesScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToGlucoseInput" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Natural Home Remedies</p>
            </div>
            <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                    Chia Seeds
                </h2>
                <p class="text-gray-700 mb-4">
                    Chia seeds are tiny powerhouses packed with nutrients. They are an excellent source of fiber, omega-3 fatty acids, and various minerals.
                </p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Benefits:</strong>
                        <ul class="list-circle list-inside ml-4">
                            <li>High in fiber, aiding digestion and promoting satiety.</li>
                            <li>Rich in omega-3 fatty acids, beneficial for heart health.</li>
                            <li>Good source of antioxidants.</li>
                            <li>Can help regulate blood sugar levels.</li>
                        </ul>
                    </li>
                    <li><strong>Usage:</strong>
                        <ul class="list-circle list-inside ml-4">
                            <li>Add 1-2 tablespoons to water or milk to make chia pudding.</li>
                            <li>Sprinkle on yogurt, oatmeal, or salads.</li>
                            <li>Incorporate into smoothies or baked goods.</li>
                        </ul>
                    </li>
                    <li><strong>Note:</strong> Ensure adequate water intake when consuming chia seeds due to their high fiber content.</li>
                </ul>
            </div>
            <div class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                <h2 class="text-xl font-semibold text-green-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm-6-10a4 4 0 100-8 4 4 0 000 8z"></path></svg>
                    Triphala
                </h2>
                <p class="text-gray-700 mb-4">
                    Triphala is an ancient Ayurvedic herbal formulation consisting of three fruits: Amalaki (Indian gooseberry), Bibhitaki, and Haritaki. It's traditionally used for digestive health.
                </p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Benefits:</strong>
                        <ul class="list-circle list-inside ml-4">
                            <li>Supports healthy digestion and bowel regularity.</li>
                            <li>Acts as a gentle colon cleanser.</li>
                            <li>Rich in antioxidants.</li>
                            <li>May support overall detoxification.</li>
                        </ul>
                    </li>
                    <li><strong>Usage:</strong>
                        <ul class="list-circle list-inside ml-4">
                            <li>Typically taken as a powder mixed with warm water, often before bed or in the morning.</li>
                            <li>Available in capsule form.</li>
                        </ul>
                    </li>
                    <li><strong>Note:</strong> Start with a small dose and increase gradually. Consult an Ayurvedic practitioner or healthcare provider for personalized guidance.</li>
                </ul>
            </div>
            <button id="finishButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md no-print">
                Finish & View Dashboard
            </button>
        </div>

        <!-- Screen 9: Summary Dashboard -->
        <div id="dashboardScreen" class="app-screen hidden">
            <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToHomeRemedies" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Your Wellness Dashboard</p>
            </div>
            <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">Your Profile Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <p><strong>Full Name:</strong> <span id="dashboardFullName"></span></p>
                    <p><strong>Age:</strong> <span id="dashboardAge"></span> years</p>
                    <p><strong>Height:</strong> <span id="dashboardHeight"></span> cm</p>
                    <p><strong>Weight:</strong> <span id="dashboardWeight"></span> kg</p>
                    <p><strong>Gender:</strong> <span id="dashboardGender"></span></p>
                    <p><strong>Diet Type:</strong> <span id="dashboardDietType"></span></p>
                    <p><strong>Lifestyle:</strong> <span id="dashboardLifestyle"></span></p>
                    <p><strong>Ideal Body Weight (Est.):</strong> <span id="dashboardIbw"></span> kg</p>
                    <p class="md:col-span-2"><strong>BMI:</strong> <span id="dashboardBmi" class="font-bold"></span> (<span id="dashboardWeightStatus" class="font-bold"></span>)</p>
                    <p class="md:col-span-2"><strong>Dietary Preferences/Restrictions:</strong> <span id="dashboardDietaryPreferences"></span></p>
                    <p><strong>Fasting Glucose:</strong> <span id="dashboardFastingGlucose"></span> mg/dL</p>
                    <p><strong>PP Glucose:</strong> <span id="dashboardPpGlucose"></span> mg/dL</p>
                    <p class="md:col-span-2"><strong>Medicines Taken:</strong> <span id="dashboardMedicinesTaken"></span></p>
                    <p class="md:col-span-2"><strong>Blood Report File:</strong> <span id="dashboardBloodReport"></span></p>
                </div>
            </div>

            <div class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                <h2 class="text-xl font-semibold text-green-800 mb-4">Calorie & Macro Goals</h2>
                <p class="text-lg text-gray-700 mb-2"><strong>BMR:</strong> <span id="dashboardBMR"></span> kcal/day</p>
                <p class="text-lg text-gray-700 mb-2"><strong>TDEE:</strong> <span id="dashboardTDEE"></span> kcal/day</p>
                <p class="text-lg font-semibold text-yellow-800 mb-4">
                    <strong>Target for Weight Loss:</strong> <span id="dashboardTargetCalories"></span> kcal/day
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-gray-700">
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Carbs</p>
                        <p class="text-2xl font-bold text-purple-600"><span id="dashboardCarbs"></span>g</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Protein</p>
                        <p class="text-2xl font-bold text-red-600"><span id="dashboardProtein"></span>g</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Fats</p>
                        <p class="text-2xl font-bold text-yellow-600"><span id="dashboardFats"></span>g</p>
                    </div>
                </div>
            </div>

            <p class="text-center text-gray-600 mt-4">
                Your full meal plan and holistic wellness recommendations were generated on previous screens.
            </p>
            <div class="mt-6 space-y-4 no-print">
                <button id="viewReportButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md">
                    View Comprehensive Report
                </button>
                <button id="startOverButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md">
                    Start Over
                </button>
            </div>
        </div>
        <!-- End Summary Dashboard -->

        <!-- Screen 10: Comprehensive Report -->
        <div id="reportScreen" class="app-screen hidden printable-report">
             <div class="flex justify-between items-center mb-6 no-print">
                <button id="backToDashboard" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-sm">
                    Back
                </button>
                <p class="text-center text-gray-600 flex-grow">Comprehensive Wellness Report</p>
                <div class="flex">
                    <button id="downloadReportButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md flex items-center justify-center">
                        <span id="downloadButtonText">Download</span>
                    </button>
                    <button id="printReportButton" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out shadow-md">
                        Print
                    </button>
                </div>
            </div>

            <!-- Report Header -->
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800">ReLife Comprehensive Wellness Report</h2>
                <p class="text-gray-600">Prepared for: <span id="reportFullName" class="font-semibold"></span></p>
                <p class="text-gray-500 text-sm">Date: <span id="reportDate"></span></p>
            </div>

            <!-- Introduction Section -->
            <div class="mb-6 p-4 border-l-4 border-blue-500 bg-blue-50">
                <h3 class="text-xl font-semibold text-blue-800 mb-2">1. Introduction</h3>
                <p class="text-gray-700">This report provides a detailed overview of your personalized wellness plan, designed to guide you on your journey toward your selected goal of <strong>Weight Loss & Diabetes Remission</strong>. It integrates nutritional targets, meal structures, and holistic lifestyle recommendations to support your health effectively.</p>
            </div>

            <!-- Profile & Caloric Needs -->
            <div class="mb-6 p-6 bg-gray-50 border border-gray-200 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Profile & Caloric Needs Summary</h3>
                <div class="grid grid-cols-2 gap-x-8 gap-y-4">
                    <p><strong>Age:</strong> <span id="reportAge"></span> years</p>
                    <p><strong>Height:</strong> <span id="reportHeight"></span> cm</p>
                    <p><strong>Weight:</strong> <span id="reportWeight"></span> kg</p>
                    <p><strong>Gender:</strong> <span id="reportGender"></span></p>
                    <p><strong>Ideal Body Weight (Est.):</strong> <span id="reportIbw" class="font-bold"></span> kg</p>
                    <p><strong>BMI:</strong> <span id="reportBmi" class="font-bold"></span></p>
                    <p class="col-span-2"><strong>Weight Status:</strong> <span id="reportWeightStatus" class="font-bold"></span></p>
                    <p class="col-span-2"><strong>Lifestyle:</strong> <span id="reportLifestyle"></span></p>
                    <p class="col-span-2"><strong>Blood Report File:</strong> <span id="reportBloodReport"></span></p>
                </div>
                <div class="mt-6 border-t pt-4">
                     <h4 class="font-semibold text-gray-700 mb-2">Estimated Daily Calorie Needs:</h4>
                     <p><strong>Basal Metabolic Rate (BMR):</strong> <strong class="text-blue-600"><span id="reportBmr"></span> calories/day</strong></p>
                     <p class="text-sm text-gray-500 mb-2">The calories your body needs at rest.</p>
                     <p><strong>Total Daily Energy Expenditure (TDEE):</strong> <strong class="text-green-600 text-lg"><span id="reportTdee"></span> calories/day</strong></p>
                     <p class="text-sm text-gray-500">Your total daily calorie burn, including activity.</p>
                </div>
            </div>
            
            <!-- Nutritional Plan -->
            <div class="mb-6 p-6 bg-green-50 border border-green-200 rounded-lg">
                <h3 class="text-xl font-semibold text-green-800 mb-4">3. Nutritional Plan for Weight Loss</h3>
                <p>To achieve a sustainable weight loss of ~500g per week, a caloric deficit is required.</p>
                <div class="my-4 p-4 bg-yellow-100 border border-yellow-300 rounded-md text-center">
                    <p class="font-semibold">Target Daily Calories for Weight Loss:</p>
                    <p class="text-3xl font-bold text-red-600"><span id="reportTargetCalories"></span> kcal/day</p>
                </div>
                 <h4 class="font-semibold text-gray-700 mb-2">Macronutrient Breakdown:</h4>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-white rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-gray-500">Protein</p>
                        <p class="text-xl font-bold text-red-600"><span id="reportProteinGrams"></span>g</p>
                        <p class="text-xs text-gray-500">(<span id="reportProteinCalories"></span> kcal)</p>
                    </div>
                     <div class="p-3 bg-white rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-gray-500">Carbohydrates</p>
                        <p class="text-xl font-bold text-purple-600"><span id="reportCarbGrams"></span>g</p>
                        <p class="text-xs text-gray-500">(<span id="reportCarbCalories"></span> kcal)</p>
                    </div>
                     <div class="p-3 bg-white rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-gray-500">Fats</p>
                        <p class="text-xl font-bold text-yellow-600"><span id="reportFatGrams"></span>g</p>
                        <p class="text-xs text-gray-500">(<span id="reportFatCalories"></span> kcal)</p>
                    </div>
                 </div>
            </div>

            <!-- Meal Plan Structure -->
             <div class="mb-6 p-6 bg-indigo-50 border border-indigo-200 rounded-lg">
                <h3 class="text-xl font-semibold text-indigo-800 mb-4">4. Sample Meal Plan Structure</h3>
                <p class="mb-4">This structure is based on your <strong id="reportDietType"></strong> preference. Use the "Generate Recipe Ideas" feature in the app for specific meals.</p>
                <div id="reportVegPlan" class="hidden">
                    <p><strong>Breakfast:</strong> Scrambled tofu with spinach and peppers; handful of mixed seeds.</p>
                    <p><strong>Lunch:</strong> Lentil soup or large chickpea salad with a keto-friendly chapati.</p>
                    <p><strong>Dinner:</strong> Paneer curry with mixed vegetables and steamed green beans.</p>
                    <p><strong>Snacks (Optional):</strong> Greek yogurt, cheese, or hummus with carrot sticks.</p>
                </div>
                <div id="reportNonVegPlan" class="hidden">
                     <p><strong>Breakfast:</strong> 3-4 scrambled eggs with smoked salmon and a handful of nuts.</p>
                    <p><strong>Lunch:</strong> Grilled chicken breast or tuna salad on greens with a keto-friendly chapati.</p>
                    <p><strong>Dinner:</strong> Baked salmon or lean turkey stir-fry with plenty of vegetables.</p>
                    <p><strong>Snacks (Optional):</strong> Hard-boiled eggs, lean meat jerky, or a protein shake.</p>
                </div>
             </div>

            <!-- Holistic Recommendations -->
            <div class="mb-6 p-6 bg-gray-50 border border-gray-200 rounded-lg">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">5. Holistic Wellness Recommendations</h3>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-lg text-blue-700">A. Sleep Plan</h4>
                        <p>Aim for <strong>7-9 hours</strong> of quality sleep per night. Maintain a consistent schedule and create a relaxing bedtime routine.</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-lg text-green-700">B. Intermittent Fasting Plan</h4>
                        <p>Consider the <strong>16/8 method</strong> (e.g., fast from 8 PM to 12 PM). Stay hydrated and focus on nutrient-dense meals.</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-lg text-purple-700">C. Hydration Plan</h4>
                        <p>Consume at least <strong>2 liters (approx. 8 glasses)</strong> of water daily, increasing with activity.</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-lg text-yellow-700">D. Exercise Plan</h4>
                        <p>Combine <strong>150 mins of moderate aerobic activity</strong> with <strong>strength training 2 days per week</strong>.</p>
                    </div>
                </div>
            </div>

            <!-- Home Remedies -->
            <div class="p-6 bg-teal-50 border border-teal-200 rounded-lg">
                <h3 class="text-xl font-semibold text-teal-800 mb-4">6. Natural Home Remedies</h3>
                 <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold">Chia Seeds</h4>
                        <p class="text-sm">High in fiber and omega-3s. Add 1-2 tbsp to water, yogurt, or smoothies to aid satiety.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold">Triphala</h4>
                        <p class="text-sm">Ayurvedic formula to support digestion. Typically taken as a powder with warm water.</p>
                    </div>
                 </div>
            </div>
        </div>
        <!-- End Comprehensive Report Screen -->

    </div>

    <script>
        // Global state to store user data across screens
        let userData = {};
        let screenHistory = []; // Stores the history of visited screens
        let currentScreen = 'verificationScreen'; // Start with the verification screen
        let geminiApiKey = ''; // To store the user-provided API key

        // Get references to all screens and the message box
        const screens = {
            verificationScreen: document.getElementById('verificationScreen'),
            kycScreen: document.getElementById('kycScreen'),
            solutionScreen: document.getElementById('solutionScreen'),
            calorieReportScreen: document.getElementById('calorieReportScreen'),
            mealPlanScreen: document.getElementById('mealPlanScreen'),
            dailyMealPlanReportScreen: document.getElementById('dailyMealPlanReportScreen'), // New meal plan report screen
            holisticPlanScreen: document.getElementById('holisticPlanScreen'),
            glucoseInputScreen: document.getElementById('glucoseInputScreen'),
            homeRemediesScreen: document.getElementById('homeRemediesScreen'),
            dashboardScreen: document.getElementById('dashboardScreen'),
            reportScreen: document.getElementById('reportScreen')
        };
        const messageBox = document.getElementById('messageBox');
        const appSubtitle = document.getElementById('appSubtitle');
        
        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' for styling.
         * @param {number} duration - Duration in milliseconds for which the message should be visible. Default to 3000ms.
         */
        function showMessage(message, type, duration = 3000) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            setTimeout(() => {
                messageBox.classList.remove(type);
                messageBox.textContent = '';
            }, duration);
        }

        /**
         * Switches the active screen.
         * @param {string} screenId - The ID of the screen to show.
         * @param {string} subtitleText - The text for the app subtitle.
         * @param {boolean} fromBack - True if navigation is triggered by 'back' button.
         */
        function showScreen(screenId, subtitleText, fromBack = false) {
            if (!fromBack && currentScreen !== screenId) {
                screenHistory.push(currentScreen); // Add current screen to history
            }
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
            currentScreen = screenId;
            appSubtitle.textContent = subtitleText;
            window.scrollTo(0, 0);
        }

        /**
         * Navigates back to the previous screen.
         */
        function goBack() {
            if (screenHistory.length > 0) {
                const prevScreenId = screenHistory.pop();
                let prevSubtitle = '';
                switch (prevScreenId) {
                    case 'verificationScreen': prevSubtitle = 'Customer Verification'; break;
                    case 'kycScreen': prevSubtitle = 'Tell us about yourself'; break;
                    case 'solutionScreen': prevSubtitle = 'Choose Your Wellness Solution'; break;
                    case 'calorieReportScreen': prevSubtitle = 'Your Personalized Calorie Report'; break;
                    case 'mealPlanScreen': prevSubtitle = 'Your Personalized Meal Plan'; break;
                    case 'dailyMealPlanReportScreen': prevSubtitle = 'Your Daily Meal Plan Report'; break;
                    case 'holisticPlanScreen': prevSubtitle = 'Your Holistic Wellness Plan'; break;
                    case 'glucoseInputScreen': prevSubtitle = 'Daily Glucose & Medication Input'; break;
                    case 'homeRemediesScreen': prevSubtitle = 'Natural Home Remedies'; break;
                    case 'dashboardScreen': prevSubtitle = 'Your Personalized Wellness Dashboard'; break;
                    case 'reportScreen': prevSubtitle = 'Comprehensive Wellness Report'; break;
                    default: prevSubtitle = 'Your Wellness Journey';
                }
                showScreen(prevScreenId, prevSubtitle, true);
            } else {
                showMessage('You are on the first screen.', 'error');
            }
        }

        // --- BMI Calculation and Status Helper Functions ---
        function calculateBMI(weightKg, heightCm) {
            if (!weightKg || !heightCm) return null;
            const heightM = heightCm / 100;
            return (weightKg / (heightM * heightM)).toFixed(1);
        }

        function getWeightStatus(bmi) {
            if (!bmi) return 'N/A';
            if (bmi < 18.5) return 'Underweight';
            if (bmi >= 18.5 && bmi < 25) return 'Normal weight';
            if (bmi >= 25 && bmi < 30) return 'Overweight';
            if (bmi >= 30) return 'Obese';
            return 'N/A';
        }

        function calculateIBW(heightCm, gender) {
            if (!heightCm || !gender || (gender !== 'male' && gender !== 'female')) return null;
            const heightInches = heightCm / 2.54;
            const inchesOver5Feet = heightInches > 60 ? heightInches - 60 : 0;
            let ibw = (gender === 'male') ? (50 + (2.3 * inchesOver5Feet)) : (45.5 + (2.3 * inchesOver5Feet));
            return ibw > 0 ? ibw.toFixed(1) : null;
        }

        // --- Screen 1: Customer Verification Logic ---
        const mobileNumberInput = document.getElementById('mobileNumber');
        const sendOtpButton = document.getElementById('sendOtpButton');
        const otpSection = document.getElementById('otpSection');
        const otpInput = document.getElementById('otp');
        const verifyOtpButton = document.getElementById('verifyOtpButton');
        let generatedOtp = '';

        sendOtpButton.addEventListener('click', () => {
            const mobileNumber = mobileNumberInput.value.trim();
            if (mobileNumber === '' || !mobileNumberInput.checkValidity()) {
                showMessage('Please enter a valid mobile number.', 'error');
                return;
            }
            generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('Simulated OTP:', generatedOtp);
            otpSection.classList.remove('hidden');
            sendOtpButton.disabled = true;
            mobileNumberInput.disabled = true;
            showMessage(`OTP sent to ${mobileNumber}. (Simulated: ${generatedOtp})`, 'success', 60000);
        });

        verifyOtpButton.addEventListener('click', () => {
            if (otpInput.value.trim() === generatedOtp) {
                showMessage('OTP verified successfully! Proceeding to KYC...', 'success');
                userData.mobileNumber = mobileNumberInput.value;
                showScreen('kycScreen', 'Tell us about yourself');
            } else {
                showMessage('Invalid OTP. Please try again.', 'error');
            }
        });

        // --- Screen 2: KYC Logic ---
        const kycForm = document.getElementById('kycForm');
        document.getElementById('backToVerification').addEventListener('click', goBack);

        kycForm.addEventListener('submit', (event) => {
            event.preventDefault();
            userData.fullName = document.getElementById('fullName').value.trim();
            userData.age = parseInt(document.getElementById('age').value);
            userData.heightCm = parseFloat(document.getElementById('heightCm').value);
            userData.weightKg = parseFloat(document.getElementById('weightKg').value);
            userData.gender = document.getElementById('gender').value;
            userData.dietType = document.getElementById('dietType').value;
            userData.lifestyle = document.getElementById('lifestyle').value;
            userData.dietaryPreferences = document.getElementById('dietaryPreferences').value.trim();

            if (!userData.fullName || isNaN(userData.age) || isNaN(userData.heightCm) || isNaN(userData.weightKg) || !userData.gender || !userData.dietType || !userData.lifestyle) {
                showMessage('Please fill in all required fields correctly.', 'error');
                return;
            }
            
            userData.bmi = calculateBMI(userData.weightKg, userData.heightCm);
            userData.weightStatus = getWeightStatus(userData.bmi);
            userData.ibw = calculateIBW(userData.heightCm, userData.gender);

            showMessage('KYC details submitted successfully!', 'success');
            showScreen('solutionScreen', 'Choose Your Wellness Solution');
        });

        // --- Screen 3: Wellness Solution Selection Logic ---
        const solutionForm = document.getElementById('solutionForm');
        const subscriptionSection = document.getElementById('subscriptionSection');
        const confirmSubscriptionButton = document.getElementById('confirmSubscriptionButton');
        document.getElementById('backToKyc').addEventListener('click', goBack);

        const fees = {
            "Diabetes Remission": "$99.99/month",
            "Blood Pressure Management": "$79.99/month",
            "Diabetes Reversal": "$129.99/month",
            "Weight Loss": "$89.99/month"
        };

        solutionForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const selectedRadio = document.querySelector('input[name="wellnessSolution"]:checked');
            if (selectedRadio) {
                userData.wellnessSolution = selectedRadio.value;
                document.getElementById('selectedSolution').textContent = userData.wellnessSolution;
                document.getElementById('subscriptionFee').textContent = fees[userData.wellnessSolution] || "N/A";
                subscriptionSection.classList.remove('hidden');
                solutionForm.querySelectorAll('div, button').forEach(el => el.classList.add('hidden'));
                showMessage(`You selected: ${userData.wellnessSolution}. Review details.`, 'success');
            } else {
                showMessage('Please select a wellness solution.', 'error');
            }
        });

        confirmSubscriptionButton.addEventListener('click', () => {
            showMessage('Subscription confirmed! Generating reports...', 'success');
            showScreen('calorieReportScreen', 'Your Personalized Calorie Report');
            generateCalorieReport();
        });

        // --- Screen 4: Calorie Consumption Report Logic ---
        document.getElementById('backToSolution').addEventListener('click', goBack);
        document.getElementById('generateMealPlanButton').addEventListener('click', () => {
            showMessage('Generating your personalized meal plan...', 'success');
            showScreen('mealPlanScreen', 'Your Personalized Meal Plan');
            generateMealPlanReport();
        });

        function calculateBMR(weightKg, heightCm, age, gender) {
            let bmr;
            if (gender.toLowerCase() === 'male') {
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            } else {
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }
            return Math.round(bmr);
        }

        function calculateTDEE(bmr, lifestyle) {
            const activityFactors = {
                'sedentary': 1.2, 'lightly-active': 1.375, 'moderately-active': 1.55,
                'very-active': 1.725, 'extra-active': 1.9
            };
            return Math.round(bmr * (activityFactors[lifestyle] || 1.2));
        }

        function generateCalorieReport() {
            const { fullName, age, heightCm, weightKg, gender, lifestyle, dietType, bmi, weightStatus } = userData;
            document.getElementById('userName').textContent = fullName;
            document.getElementById('userAge').textContent = age;
            document.getElementById('userHeight').textContent = heightCm;
            document.getElementById('userWeight').textContent = weightKg;
            document.getElementById('userGender').textContent = gender.charAt(0).toUpperCase() + gender.slice(1);
            document.getElementById('userLifestyle').textContent = lifestyle.replace(/-/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
            document.getElementById('userDietType').textContent = dietType.charAt(0).toUpperCase() + dietType.slice(1);
            document.getElementById('userBmi').textContent = bmi || 'N/A';
            document.getElementById('userWeightStatus').textContent = weightStatus || 'N/A';

            const bmr = calculateBMR(weightKg, heightCm, age, gender);
            const tdee = calculateTDEE(bmr, lifestyle);
            userData.bmr = bmr;
            userData.tdee = tdee;

            document.getElementById('bmrValue').textContent = bmr;
            document.getElementById('tdeeValue').textContent = tdee;
        }

        // --- Screen 5: Meal Plan Report Logic ---
        const viewMealPlanReportButton = document.getElementById('viewMealPlanReportButton');
        const nextToHolisticPlanButton = document.getElementById('nextToHolisticPlanButton');
        const generateRecipesButton = document.getElementById('generateRecipesButton');
        const generatedRecipesOutput = document.getElementById('generatedRecipesOutput');
        document.getElementById('backToCalorieReport').addEventListener('click', goBack);

        function generateMealPlanReport() {
            const { tdee, weightKg, ibw } = userData;
            const targetCaloriesForWeightLoss = Math.max(1200, tdee - 550);
            userData.targetCaloriesForWeightLoss = targetCaloriesForWeightLoss;

            document.getElementById('mealPlanTdeeValue').textContent = tdee;
            document.getElementById('mealPlanUserWeight').textContent = weightKg;
            document.getElementById('mealPlanIbw').textContent = ibw || 'N/A';
            document.getElementById('targetWeightLossCalories').textContent = targetCaloriesForWeightLoss;

            const proteinGrams = 2 * weightKg;
            const proteinCalories = proteinGrams * 4;
            const carbGrams = 50;
            const carbCalories = carbGrams * 4;
            const fatCalories = Math.max(0, targetCaloriesForWeightLoss - proteinCalories - carbCalories);
            const fatGrams = fatCalories / 9;

            userData.proteinGrams = proteinGrams;
            userData.proteinCalories = proteinCalories;
            userData.carbGrams = carbGrams;
            userData.carbCalories = carbCalories;
            userData.fatGrams = fatGrams;
            userData.fatCalories = fatCalories;

            document.getElementById('carbGrams').textContent = Math.round(carbGrams);
            document.getElementById('carbCalories').textContent = Math.round(carbCalories);
            document.getElementById('proteinGrams').textContent = Math.round(proteinGrams);
            document.getElementById('proteinCalories').textContent = Math.round(proteinCalories);
            document.getElementById('fatGrams').textContent = Math.round(fatGrams);
            document.getElementById('fatCalories').textContent = Math.round(fatCalories);
        }

        generateRecipesButton.addEventListener('click', async () => {
            const generateRecipesButtonText = document.getElementById('generateRecipesButtonText');
            const generateRecipesSpinner = document.getElementById('generateRecipesSpinner');
            
            generateRecipesButton.disabled = true;
            generateRecipesButtonText.textContent = 'Generating...';
            generateRecipesSpinner.classList.remove('hidden');
            generatedRecipesOutput.textContent = 'Fetching delicious ideas for you...';

            // Check for API Key. The key provided by the Canvas environment is an empty string.
            // On a live site, this will need to be provided by the user.
            let apiKey = geminiApiKey;
            if (apiKey === '') {
                // This is a special check for the Canvas environment.
                // If __initial_auth_token is NOT defined, it means we are likely on a live site.
                if (typeof __initial_auth_token === 'undefined') {
                    document.getElementById('apiKeySection').classList.remove('hidden');
                    showMessage('Please provide a Gemini API key to generate recipes.', 'error', 5000);
                    generateRecipesButton.disabled = false;
                    generateRecipesButtonText.textContent = 'Generate Recipe Ideas';
                    generateRecipesSpinner.classList.add('hidden');
                    return; // Stop execution
                }
            }

            const { dietType, dietaryPreferences, targetCaloriesForWeightLoss, proteinGrams, carbGrams, fatGrams } = userData;
            const availableGroceries = document.getElementById('availableGroceries').value.trim();
            userData.availableGroceries = availableGroceries;

            let prompt = `Generate a daily meal plan with 3-4 distinct recipe ideas (Breakfast, Lunch, Dinner, and optionally 1-2 snacks) for a ${dietType} person. The goal is weight loss, with a target of ${targetCaloriesForWeightLoss} kcal. Macronutrient goals: ${Math.round(proteinGrams)}g Protein, ${Math.round(carbGrams)}g Carbs, ${Math.round(fatGrams)}g Fat.`;
            if (availableGroceries) {
                prompt += ` IMPORTANT: Base the recipes on these available groceries: ${availableGroceries}. Supplement with common staples only if necessary.`;
            }
            if (dietaryPreferences) {
                prompt += ` Adhere to these restrictions: ${dietaryPreferences}.`;
            }
            prompt += ` For each meal, provide a simple recipe, key ingredients, and estimated calories. Format with clear headings.`;

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    userData.generatedMealPlanText = generatedText; // Save for the report
                    generatedRecipesOutput.innerHTML = generatedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    showMessage('Recipe ideas generated!', 'success');
                    viewMealPlanReportButton.classList.remove('hidden'); // Show the view report button
                    nextToHolisticPlanButton.classList.add('hidden'); // Hide the skip button
                } else {
                    let errorMessage = 'Could not generate recipes. The AI returned an empty or unexpected response.';
                    if (result.promptFeedback?.blockReason) {
                        errorMessage += ` Reason: ${result.promptFeedback.blockReason}.`;
                    }
                    generatedRecipesOutput.textContent = errorMessage;
                    showMessage(errorMessage, 'error', 5000);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                generatedRecipesOutput.textContent = `Error generating recipes: ${error.message}. Please try again.`;
                showMessage('Error generating recipes.', 'error');
            } finally {
                generateRecipesButton.disabled = false;
                generateRecipesButtonText.textContent = 'Generate Recipe Ideas';
                generateRecipesSpinner.classList.add('hidden');
            }
        });
        
        document.getElementById('saveApiKeyButton').addEventListener('click', () => {
            const keyInput = document.getElementById('geminiApiKey');
            const key = keyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                geminiApiKey = key;
                document.getElementById('apiKeySection').classList.add('hidden');
                showMessage('API Key saved. Generating recipes...', 'success');
                generateRecipesButton.click();
            } else {
                showMessage('Please enter a valid API key.', 'error');
            }
        });

        document.getElementById('clearApiKeyButton').addEventListener('click', () => {
            localStorage.removeItem('geminiApiKey');
            geminiApiKey = '';
            document.getElementById('geminiApiKey').value = '';
            showMessage('API Key cleared from browser storage.', 'success');
        });

        viewMealPlanReportButton.addEventListener('click', () => {
            populateAndShowDailyMealPlanReport();
        });

        nextToHolisticPlanButton.addEventListener('click', () => {
            showScreen('holisticPlanScreen', 'Your Holistic Wellness Plan');
        });

        // --- Screen 5.5: Daily Meal Plan Report Logic ---
        document.getElementById('backToMealPlanFromReport').addEventListener('click', goBack);
        document.getElementById('mealReportToHolisticPlanButton').addEventListener('click', () => {
            showScreen('holisticPlanScreen', 'Your Holistic Wellness Plan');
        });
        document.getElementById('printMealPlanButton').addEventListener('click', () => {
             // Temporarily hide other screens to ensure only this report is printed
            Object.values(screens).forEach(screen => { if(screen.id !== 'dailyMealPlanReportScreen') screen.classList.add('hidden'); });
            window.print();
        });
        document.getElementById('downloadMealPlanButton').addEventListener('click', () => {
            downloadReportAsPDF('dailyMealPlanReportScreen', `ReLife_Meal_Plan_${(userData.fullName || 'user').replace(/\s+/g, '_')}.pdf`);
        });

        function populateAndShowDailyMealPlanReport() {
            document.getElementById('mealReportFullName').textContent = userData.fullName || 'N/A';
            document.getElementById('mealReportDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('mealReportDietType').textContent = userData.dietType ? userData.dietType.charAt(0).toUpperCase() + userData.dietType.slice(1) : 'N/A';
            document.getElementById('mealReportPantryItems').textContent = userData.availableGroceries || 'None specified';
            document.getElementById('mealReportDietaryPreferences').textContent = userData.dietaryPreferences || 'None specified';
            document.getElementById('mealReportTargetCalories').textContent = userData.targetCaloriesForWeightLoss || 'N/A';
            document.getElementById('dailyMealPlanReportOutput').innerHTML = (userData.generatedMealPlanText || 'No meal plan generated.').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            showScreen('dailyMealPlanReportScreen', 'Your Daily Meal Plan Report');
        }

        // --- Screen 6: Holistic Wellness Plan Logic ---
        document.getElementById('backToMealPlan').addEventListener('click', goBack);
        document.getElementById('nextToGlucoseInputButton').addEventListener('click', () => {
            showScreen('glucoseInputScreen', 'Daily Glucose & Medication Input');
        });

        // --- Screen 7: Glucose Input Logic ---
        const glucoseInputForm = document.getElementById('glucoseInputForm');
        document.getElementById('backToHolisticPlanFromGlucose').addEventListener('click', goBack);

        document.getElementById('bloodReportUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            document.getElementById('fileNameDisplay').textContent = file ? `Selected file: ${file.name}` : '';
        });

        glucoseInputForm.addEventListener('submit', (event) => {
            event.preventDefault();
            userData.fastingGlucose = document.getElementById('fastingGlucose').value.trim();
            userData.ppGlucose = document.getElementById('ppGlucose').value.trim();
            userData.medicinesTaken = document.getElementById('medicinesTaken').value.trim();
            const bloodReportFile = document.getElementById('bloodReportUpload').files[0];
            userData.bloodReportFile = bloodReportFile ? bloodReportFile.name : 'Not provided';
            
            if (!userData.fastingGlucose && !userData.ppGlucose && !userData.medicinesTaken && !bloodReportFile) {
                 showMessage('Please enter at least one value or upload a report.', 'error');
                 return;
            }
            showScreen('homeRemediesScreen', 'Natural Home Remedies');
        });

        // --- Screen 8: Home Remedies Logic ---
        document.getElementById('backToGlucoseInput').addEventListener('click', goBack);
        document.getElementById('finishButton').addEventListener('click', () => {
            showMessage('Congratulations! Your plan is complete!', 'success');
            populateDashboard();
            showScreen('dashboardScreen', 'Your Wellness Dashboard');
        });

        // --- Screen 9: Dashboard Logic ---
        document.getElementById('backToHomeRemedies').addEventListener('click', goBack);
        document.getElementById('viewReportButton').addEventListener('click', () => populateAndShowReport());
        document.getElementById('startOverButton').addEventListener('click', () => {
            userData = {};
            screenHistory = []; 
            kycForm.reset();
            solutionForm.reset();
            glucoseInputForm.reset();
            ['dietaryPreferences', 'availableGroceries'].forEach(id => document.getElementById(id).value = '');
            generatedRecipesOutput.innerHTML = 'Enter your available groceries above and click "Generate Recipe Ideas" to get personalized suggestions!';
            document.getElementById('fileNameDisplay').textContent = '';
            subscriptionSection.classList.add('hidden');
            solutionForm.querySelectorAll('div, button').forEach(el => el.classList.remove('hidden'));
            viewMealPlanReportButton.classList.add('hidden');
            nextToHolisticPlanButton.classList.remove('hidden');
            showScreen('verificationScreen', 'Customer Verification');
        });

        function populateDashboard() {
            const fields = {
                'dashboardFullName': userData.fullName, 'dashboardAge': userData.age, 'dashboardHeight': userData.heightCm,
                'dashboardWeight': userData.weightKg, 'dashboardBmi': userData.bmi, 'dashboardWeightStatus': userData.weightStatus,
                'dashboardIbw': userData.ibw, 'dashboardDietaryPreferences': userData.dietaryPreferences || 'None',
                'dashboardFastingGlucose': userData.fastingGlucose || 'N/A', 'dashboardPpGlucose': userData.ppGlucose || 'N/A',
                'dashboardMedicinesTaken': userData.medicinesTaken || 'None', 'dashboardBloodReport': userData.bloodReportFile,
                'dashboardBMR': userData.bmr, 'dashboardTDEE': userData.tdee, 'dashboardTargetCalories': userData.targetCaloriesForWeightLoss,
                'dashboardCarbs': Math.round(userData.carbGrams), 'dashboardProtein': Math.round(userData.proteinGrams),
                'dashboardFats': Math.round(userData.fatGrams),
                'dashboardGender': userData.gender ? userData.gender.charAt(0).toUpperCase() + userData.gender.slice(1) : 'N/A',
                'dashboardDietType': userData.dietType ? userData.dietType.charAt(0).toUpperCase() + userData.dietType.slice(1) : 'N/A',
                'dashboardLifestyle': userData.lifestyle ? userData.lifestyle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'N/A'
            };
            for (const id in fields) {
                document.getElementById(id).textContent = fields[id] || 'N/A';
            }
        }

        // --- Screen 10: Comprehensive Report Logic ---
        document.getElementById('backToDashboard').addEventListener('click', goBack);
        document.getElementById('printReportButton').addEventListener('click', () => {
            Object.values(screens).forEach(screen => { if(screen.id !== 'reportScreen') screen.classList.add('hidden'); });
            window.print();
        });
        document.getElementById('downloadReportButton').addEventListener('click', () => {
            downloadReportAsPDF('reportScreen', `ReLife_Comprehensive_Report_${(userData.fullName || 'user').replace(/\s+/g, '_')}.pdf`);
        });
        
        function downloadReportAsPDF(elementId, filename) {
            const reportElement = document.getElementById(elementId);
            const downloadButton = reportElement.querySelector('.bg-purple-600'); // Generic selector
            const originalButtonContent = downloadButton.innerHTML;
            
            downloadButton.disabled = true;
            downloadButton.innerHTML = `<span class="spinner"></span> <span>Downloading...</span>`;

            const options = { margin: 0.5, filename: filename, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            
            const reportClone = reportElement.cloneNode(true);
            reportClone.querySelectorAll('.no-print').forEach(el => el.remove());

            html2pdf().from(reportClone).set(options).save().then(() => {
                downloadButton.disabled = false;
                downloadButton.innerHTML = originalButtonContent;
                showMessage('Report downloaded!', 'success');
            }).catch(err => {
                downloadButton.disabled = false;
                downloadButton.innerHTML = originalButtonContent;
                showMessage('Failed to download report.', 'error');
                console.error('PDF generation error:', err);
            });
        }
        
        function populateAndShowReport() {
            const fields = {
                'reportFullName': userData.fullName, 'reportAge': userData.age, 'reportHeight': userData.heightCm,
                'reportWeight': userData.weightKg, 'reportBmi': userData.bmi, 'reportWeightStatus': userData.weightStatus,
                'reportIbw': userData.ibw, 'reportBmr': userData.bmr, 'reportTdee': userData.tdee,
                'reportTargetCalories': userData.targetCaloriesForWeightLoss, 'reportProteinGrams': Math.round(userData.proteinGrams),
                'reportProteinCalories': Math.round(userData.proteinCalories), 'reportCarbGrams': Math.round(userData.carbGrams),
                'reportCarbCalories': Math.round(userData.carbCalories), 'reportFatGrams': Math.round(userData.fatGrams),
                'reportFatCalories': Math.round(userData.fatCalories), 'reportBloodReport': userData.bloodReportFile,
                'reportGender': userData.gender ? userData.gender.charAt(0).toUpperCase() + userData.gender.slice(1) : 'N/A',
                'reportLifestyle': userData.lifestyle ? userData.lifestyle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'N/A',
                'reportDietType': userData.dietType ? userData.dietType.charAt(0).toUpperCase() + userData.dietType.slice(1) : 'N/A'
            };
            for (const id in fields) {
                document.getElementById(id).textContent = fields[id] || 'N/A';
            }
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const reportWeightStatusSpan = document.getElementById('reportWeightStatus');
            reportWeightStatusSpan.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
            if (userData.weightStatus === 'Normal weight') reportWeightStatusSpan.classList.add('text-green-600');
            else if (userData.weightStatus === 'Overweight') reportWeightStatusSpan.classList.add('text-yellow-600');
            else if (userData.weightStatus === 'Obese' || userData.weightStatus === 'Underweight') reportWeightStatusSpan.classList.add('text-red-600');

            const vegPlan = document.getElementById('reportVegPlan');
            const nonVegPlan = document.getElementById('reportNonVegPlan');
            vegPlan.classList.toggle('hidden', userData.dietType !== 'vegetarian');
            nonVegPlan.classList.toggle('hidden', userData.dietType === 'vegetarian');

            showScreen('reportScreen', 'Comprehensive Wellness Report');
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Load the API key from local storage if it exists
            geminiApiKey = localStorage.getItem('geminiApiKey') || '';
            
            // This variable is provided by the Canvas environment. If it's undefined, we're likely on a live site.
            if (typeof __initial_auth_token === 'undefined' && !geminiApiKey) {
                console.log("Running on a live site without an API key.");
            } else if (typeof __initial_auth_token !== 'undefined') {
                // In the Canvas preview, the API key is handled automatically. We can set it to an empty string.
                geminiApiKey = '';
            }

            showScreen('verificationScreen', 'Customer Verification');
        });
    </script>
</body>
</html>
